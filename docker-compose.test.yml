version: '3.8'

# Minimal test setup for rsky-indexer testing
# Uses existing local test containers + builds TypeScript dataplane

networks:
  test-net:
    driver: bridge

services:
  # Use existing test postgres (external)
  # Connect via: host.docker.internal:5433

  # Use existing test redis (external)
  # Connect via: host.docker.internal:6379

  # =================================================================
  # DATAPLANE - Creates database schema on startup
  # =================================================================
  dataplane:
    build:
      context: ../atproto
      dockerfile: Dockerfile
      target: bsky-dev
    container_name: test-dataplane
    restart: unless-stopped
    networks:
      - test-net
    ports:
      - "3300:3300"
    environment:
      DATAPLANE_PORT: "3300"
      REDIS_HOST: "host.docker.internal:6379"
      DB_POSTGRES_URL: "postgresql://postgres:postgres@host.docker.internal:5433/postgres"
      LOG_ENABLED: "true"
      LOG_LEVEL: "info"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: sh -c "cd services/bsky && node dataplane.js"
    mem_limit: 4g
    cpus: 2

  # =================================================================
  # API - Optional, for testing queries
  # =================================================================
  api:
    build:
      context: ../atproto
      dockerfile: Dockerfile
      target: bsky-dev
    container_name: test-api
    restart: unless-stopped
    networks:
      - test-net
    ports:
      - "3000:3000"
    environment:
      BSKY_VERSION: "test"
      BSKY_PORT: "3000"
      BSKY_DATAPLANE_URLS: "http://dataplane:3300"
      BSKY_PUBLIC_URL: "http://localhost:3000"
      BSKY_SERVER_DID: "did:web:localhost"
      BSKY_SERVICE_SIGNING_KEY: "e9993faa14a046b88c28fb28d2802f92c2e19adf018a68fe402a651cdf57205c"
      BSKY_DATAPLANE_HTTP_VERSION: "1.1"
      BSKY_DATAPLANE_IGNORE_BAD_TLS: "true"
      BSKY_CDN_URL: "https://cdn.bsky.app/img"
      BSKY_LABELS_FROM_ISSUER_DIDS: "did:plc:ar7c4by46qjdydhdevvrndac"
      BSKY_INDEXED_AT_EPOCH: "2022-11-17T00:00:00.000Z"
      LOG_ENABLED: "true"
      LOG_LEVEL: "info"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: sh -c "cd services/bsky && node api-basic.js"
    depends_on:
      - dataplane
    mem_limit: 2g
    cpus: 2
