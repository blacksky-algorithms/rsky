version: '3.8'

networks:
  backfill-net:
    driver: bridge

services:
  # =================================================================
  # REDIS - Standard Redis (keep existing)
  # =================================================================
  redis:
    image: redis:7-alpine
    container_name: backfill-redis
    restart: unless-stopped
    networks:
      - backfill-net
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 32gb --maxmemory-policy noeviction
    ports:
      - "6380:6379"
    volumes:
      - /data/backfill-redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =================================================================
  # PGBOUNCER 1 - For indexers 1-3
  # =================================================================
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: backfill-pgbouncer1
    restart: unless-stopped
    networks:
      - backfill-net
    ports:
      - "15433:5432"
    environment:
      - DB_HOST=host.docker.internal
      - DB_PORT=15432
      - DB_USER=bsky
      - DB_PASSWORD=BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh
      - DB_NAME=bsky
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=1000
      - DEFAULT_POOL_SIZE=100
      - RESERVE_POOL_SIZE=50
      - MIN_POOL_SIZE=25
      - AUTH_TYPE=scram-sha-256
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # =================================================================
  # PGBOUNCER 2 - For indexers 4-6
  # =================================================================
  pgbouncer2:
    image: edoburu/pgbouncer:latest
    container_name: backfill-pgbouncer2
    restart: unless-stopped
    networks:
      - backfill-net
    ports:
      - "15434:5432"
    environment:
      - DB_HOST=host.docker.internal
      - DB_PORT=15432
      - DB_USER=bsky
      - DB_PASSWORD=BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh
      - DB_NAME=bsky
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=1000
      - DEFAULT_POOL_SIZE=100
      - RESERVE_POOL_SIZE=50
      - MIN_POOL_SIZE=25
      - AUTH_TYPE=scram-sha-256
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # =================================================================
  # DATAPLANE INSTANCES (Keep TypeScript - no Rust replacement yet)
  # =================================================================
  dataplane1:
    image: blacksky-bsky:custom
    restart: unless-stopped
    networks:
      - backfill-net
    command: node dataplane.js
    environment:
      DATAPLANE_PORT: "3300"
      REDIS_HOST: "redis:6379"
      DB_POSTGRES_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      LOG_ENABLED: "true"
      LOG_LEVEL: "info"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 15g
    cpus: 2

  dataplane2:
    image: blacksky-bsky:custom
    restart: unless-stopped
    networks:
      - backfill-net
    command: node dataplane.js
    environment:
      DATAPLANE_PORT: "3301"
      REDIS_HOST: "redis:6379"
      DB_POSTGRES_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      LOG_ENABLED: "true"
      LOG_LEVEL: "info"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 15g
    cpus: 2

  # =================================================================
  # API SERVER (Keep TypeScript - no Rust replacement yet)
  # =================================================================
  api1:
    image: blacksky-bsky:custom
    container_name: backfill-api1
    restart: unless-stopped
    networks:
      - backfill-net
    command: node api-basic.js
    ports:
      - "3000:3000"
    environment:
      BSKY_VERSION: "custom"
      BSKY_PORT: "3000"
      BSKY_DATAPLANE_URLS: "http://dataplane1:3300,http://dataplane2:3301"
      BSKY_PUBLIC_URL: "https://api.blacksky.community"
      BSKY_SERVER_DID: "did:web:api.blacksky.community"
      BSKY_SERVICE_SIGNING_KEY: "e9993faa14a046b88c28fb28d2802f92c2e19adf018a68fe402a651cdf57205c"
      BSKY_DATAPLANE_HTTP_VERSION: "1.1"
      BSKY_DATAPLANE_IGNORE_BAD_TLS: "true"
      BSKY_CDN_URL: "https://cdn.bsky.app/img"
      BSKY_VIDEO_PLAYLIST_URL_PATTERN: "https://video.bsky.app/watch/%s/%s/playlist.m3u8"
      BSKY_VIDEO_THUMBNAIL_URL_PATTERN: "https://video.bsky.app/watch/%s/%s/thumbnail.jpg"
      BSKY_LABELS_FROM_ISSUER_DIDS: "did:plc:ar7c4by46qjdydhdevvrndac"
      MOD_SERVICE_DID: "did:plc:ar7c4by46qjdydhdevvrndac"
      BSKY_INDEXED_AT_EPOCH: "2022-11-17T00:00:00.000Z"
      BSKY_BSYNC_URL: "http://bsync.invalid"
      LOG_ENABLED: "true"
      LOG_LEVEL: "info"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 8g
    cpus: 4

  # =================================================================
  # RUST INGESTER - Replaces TypeScript ingester
  # More efficient, lower memory usage
  # =================================================================
  ingester:
    image: rsky-ingester:latest
    container_name: rust-ingester
    restart: unless-stopped
    networks:
      - backfill-net
    ports:
      - "4100:4100"
    environment:
      # Ingester configuration
      INGESTER_RELAY_HOSTS: "https://relay1.us-east.bsky.network,https://relay1.us-west.bsky.network,https://atproto.africa"
      INGESTER_LABELER_HOSTS: "https://atproto.africa"
      INGESTER_HIGH_WATER_MARK: "100000000"
      INGESTER_BATCH_SIZE: "500"
      INGESTER_BATCH_TIMEOUT_MS: "100"
      # Redis configuration
      REDIS_URL: "redis://redis:6379"
      # Logging
      RUST_LOG: "info,rsky_ingester=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 2g
    cpus: 2

  # =================================================================
  # RUST BACKFILLERS - Replaces 3 TypeScript backfillers with 2 Rust
  # Higher efficiency allows fewer instances at same throughput
  # =================================================================
  backfiller1:
    image: rsky-backfiller:latest
    container_name: rust-backfiller1
    restart: unless-stopped
    networks:
      - backfill-net
    ports:
      - "9091:9090"  # Metrics port
    environment:
      # Backfiller configuration
      BACKFILLER_CONSUMER: "rust-backfiller1"
      BACKFILLER_CONCURRENCY: "20"
      BACKFILLER_BATCH_SIZE: "500"
      # Redis configuration
      REDIS_URL: "redis://redis:6379"
      # Database configuration (via PGBouncer)
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      # Retry and timeout configuration
      BACKFILLER_HTTP_TIMEOUT_SECS: "60"
      BACKFILLER_MAX_RETRIES: "3"
      BACKFILLER_RETRY_INITIAL_BACKOFF_MS: "1000"
      BACKFILLER_RETRY_MAX_BACKOFF_MS: "30000"
      # Metrics
      BACKFILLER_METRICS_PORT: "9090"
      # Logging
      RUST_LOG: "info,rsky_backfiller=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 2

  backfiller2:
    image: rsky-backfiller:latest
    container_name: rust-backfiller2
    restart: unless-stopped
    networks:
      - backfill-net
    ports:
      - "9092:9090"  # Metrics port
    environment:
      BACKFILLER_CONSUMER: "rust-backfiller2"
      BACKFILLER_CONCURRENCY: "20"
      BACKFILLER_BATCH_SIZE: "500"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      # Retry and timeout configuration
      BACKFILLER_HTTP_TIMEOUT_SECS: "60"
      BACKFILLER_MAX_RETRIES: "3"
      BACKFILLER_RETRY_INITIAL_BACKOFF_MS: "1000"
      BACKFILLER_RETRY_MAX_BACKOFF_MS: "30000"
      # Metrics
      BACKFILLER_METRICS_PORT: "9090"
      RUST_LOG: "info,rsky_backfiller=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 2

  # =================================================================
  # RUST INDEXERS - Replaces 8 TypeScript indexers with 6 Rust
  # Each Rust indexer runs at concurrency=100 vs TypeScript concurrency=12
  # 6 instances × 100 concurrency = 600 total (vs 8 × 12 = 96)
  # 6x increase in theoretical throughput with better resource efficiency
  # =================================================================
  indexer1:
    image: rsky-indexer:latest
    container_name: rust-indexer1
    restart: unless-stopped
    networks:
      - backfill-net
    environment:
      # Indexer configuration
      INDEXER_CONSUMER: "rust-indexer1"
      INDEXER_CONCURRENCY: "100"
      INDEXER_BATCH_SIZE: "500"
      # Redis configuration
      REDIS_URL: "redis://redis:6379"
      # Database configuration (via PGBouncer)
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      # Pool configuration (2x concurrency for optimal performance)
      DB_POOL_MAX_SIZE: "200"
      DB_POOL_MIN_IDLE: "50"
      # DID resolution
      ENABLE_DID_RESOLUTION: "true"
      # Logging
      RUST_LOG: "info,rsky_indexer=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 4

  indexer2:
    image: rsky-indexer:latest
    container_name: rust-indexer2
    restart: unless-stopped
    networks:
      - backfill-net
    environment:
      INDEXER_CONSUMER: "rust-indexer2"
      INDEXER_CONCURRENCY: "100"
      INDEXER_BATCH_SIZE: "500"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      DB_POOL_MAX_SIZE: "200"
      DB_POOL_MIN_IDLE: "50"
      ENABLE_DID_RESOLUTION: "true"
      RUST_LOG: "info,rsky_indexer=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 4

  indexer3:
    image: rsky-indexer:latest
    container_name: rust-indexer3
    restart: unless-stopped
    networks:
      - backfill-net
    environment:
      INDEXER_CONSUMER: "rust-indexer3"
      INDEXER_CONCURRENCY: "100"
      INDEXER_BATCH_SIZE: "500"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer:5432/bsky"
      DB_POOL_MAX_SIZE: "200"
      DB_POOL_MIN_IDLE: "50"
      ENABLE_DID_RESOLUTION: "true"
      RUST_LOG: "info,rsky_indexer=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 4

  indexer4:
    image: rsky-indexer:latest
    container_name: rust-indexer4
    restart: unless-stopped
    networks:
      - backfill-net
    environment:
      INDEXER_CONSUMER: "rust-indexer4"
      INDEXER_CONCURRENCY: "100"
      INDEXER_BATCH_SIZE: "500"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer2:5432/bsky"
      DB_POOL_MAX_SIZE: "200"
      DB_POOL_MIN_IDLE: "50"
      ENABLE_DID_RESOLUTION: "true"
      RUST_LOG: "info,rsky_indexer=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 4

  indexer5:
    image: rsky-indexer:latest
    container_name: rust-indexer5
    restart: unless-stopped
    networks:
      - backfill-net
    environment:
      INDEXER_CONSUMER: "rust-indexer5"
      INDEXER_CONCURRENCY: "100"
      INDEXER_BATCH_SIZE: "500"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer2:5432/bsky"
      DB_POOL_MAX_SIZE: "200"
      DB_POOL_MIN_IDLE: "50"
      ENABLE_DID_RESOLUTION: "true"
      RUST_LOG: "info,rsky_indexer=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 4

  indexer6:
    image: rsky-indexer:latest
    container_name: rust-indexer6
    restart: unless-stopped
    networks:
      - backfill-net
    environment:
      INDEXER_CONSUMER: "rust-indexer6"
      INDEXER_CONCURRENCY: "100"
      INDEXER_BATCH_SIZE: "500"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://bsky:BEVoNPm7z0lT5tMAv6hF5SQUMkIQBTRHhx0JiKjxCsdVTR274zxdPw5o9CGtpmgh@pgbouncer2:5432/bsky"
      DB_POOL_MAX_SIZE: "200"
      DB_POOL_MIN_IDLE: "50"
      ENABLE_DID_RESOLUTION: "true"
      RUST_LOG: "info,rsky_indexer=info"
      RUST_BACKTRACE: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    mem_limit: 4g
    cpus: 4

  # =================================================================
  # PROMETHEUS - Monitoring (keep existing)
  # =================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    networks:
      - backfill-net
    ports:
      - "9090:9090"
    volumes:
      - /data/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    mem_limit: 2g
